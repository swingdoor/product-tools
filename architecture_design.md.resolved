# AI产品工具 (ProductTools) 详细架构设计说明书

## 1. 整体架构概述

本项目是一个基于 **Electron + Vue 3 + TypeScript** 构建的 AI 辅助产品工具。系统采用了严格的 **分层架构 (Layered Architecture)**，旨在实现关注点分离（SoC）、提高代码的可维护性和可测试性。

架构整体分为前端展示进程（Renderer Process）和后端主进程（Main Process），两者通过 Electron 的 IPC (Inter-Process Communication) 进行安全通信。

---

## 2. 七层结构详细说明

系统由下至上（从数据存储到用户界面）共分为七层：

### 第一层：显示与状态层 (Frontend UI & State)
*   **功能**：负责用户界面的呈现、交互逻辑以及应用侧的状态管理。
*   **核心组件**：
    *   **Vue 3 (Composition API)**：用于构建组件化的 UI（如 [src/views/PrototypeList.vue](file:///d:/code_project/product_tools3/src/views/PrototypeList.vue)）。
    *   **Pinia (Store)**：集中管理业务状态，并负责触发 API 调用（如 [src/stores/productPrototype.ts](file:///d:/code_project/product_tools3/src/stores/productPrototype.ts)）。
    *   **Element Plus**：提供标准的 UI 组件库。

### 第二层：前端 API 封装层 (Renderer API Bridge)
*   **功能**：将 Electron 原始的 IPC 调用封装成标准的异步 TypeScript 函数，为 Store 提供干净的调用接口。
*   **实现说明**：位于 `src/api/` 目录下（如 `marketApi.ts`）。它不包含业务逻辑，仅作为 IPC 通信的“客户端代理”。

### 第三层：IPC 接口层 (IPC & Preload Bridge)
*   **功能**：连接渲染进程与主进程，定义跨进程通信的安全上下文。
*   **核心组件**：
    *   **Preload (`electron/preload.ts`)**：通过 `contextBridge` 安全地暴露接口给前端。
    *   **IPC Handlers (`electron/ipc.ts`)**：在主进程监听前端发来的指令，并将其路由到对应的控制器。

### 第四层：控制层 (Controller Layer)
*   **功能**：作为后端逻辑的入口，负责接收 IPC 请求、验证输入参数，并调用相应的 Service。
*   **位置**：`electron/controllers/`（如 `prototype.ts`, `market.ts`）。
*   **实现说明**：类似于 Web 后端的路由处理函数，它协调多个 Service 并返回最终结果。

### 第五层：业务服务层 (Service Layer)
*   **功能**：系统的核心大脑，负责处理复杂的业务流程、AI 接口调度、异步任务管理。
*   **核心组件**：
    *   **任务服务**：`electron/services/marketService.ts` 等。
    *   **AI 引擎**：`electron/services/ai.ts` 负责与大模型通信。
    *   **任务运行器**：`electron/services/taskRunner.ts` 管理耗时任务的执行状态。

### 第六层：数据访问层 (Repository / DAL Layer)
*   **功能**：封装对数据库的底层操作，屏蔽 SQL 或数据库结构的复杂性。
*   **位置**：`electron/db/repositories/`（如 `projectRepo.ts`, `analysisRepo.ts`）。
*   **实现说明**：提供 CRUD 接口（Create, Read, Update, Delete），使得 Service 层无需关心数据是如何存储的。

### 第七层：持久化层 (Database Layer)
*   **功能**：底层数据物理存储与连接管理。
*   **核心组件**：
    *   **SQLite**：使用 `better-sqlite3` 作为嵌入式数据库，存储任务详情、报告和配置。
    *   **Connection (`electron/db/connection.ts`)**：负责数据库的初始化、表结构迁移 (Migration) 以及连接池管理。

---

## 3. 请求流向示例 (以创建原型任务为例)

1.  **UI**: 用户在 `PrototypeList.vue` 点击新建。
2.  **Store**: `productPrototype.ts` 调用 `prototypeApi.createTask()`。
3.  **API**: `src/api/projectApi.ts` 通过 `ipcRenderer` 发送消息。
4.  **IPC**: `electron/ipc.ts` 监听到消息，调用 `prototypeController.createTask()`。
5.  **Service**: `prototypeController` 调用 `projectService.create()` 处理初始业务逻辑。
6.  **Repo**: `projectService` 调用 `projectRepo.insert()`。
7.  **DB**: `projectRepo` 执行 SQL 语句写入 `better-sqlite3`。

---

## 4. 架构优势
*   **低耦合**：更换 UI 框架、数据库甚至通信方式时，只需修改对应层，不影响其他部分。
*   **易于维护**：每一层都有明确的职责范围，方便定位 Bug。
*   **强类型**：从前端到后端 Repository 全程使用 TypeScript，极大减少了运行时的错误。
